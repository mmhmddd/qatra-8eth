<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
  <div class="container-fluid p-0" [dir]="translationService.isRtl() ? 'rtl' : 'ltr'">
    <main class="main-content container">
      <!-- Toast Container for Notifications -->
      <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
        <div *ngFor="let toast of toasts"
             class="toast"
             [id]="toast.id"
             [ngClass]="{'toast-success': toast.type === 'success', 'toast-error': toast.type === 'error', 'toast-info': toast.type === 'info'}"
             role="alert"
             aria-live="assertive"
             aria-atomic="true">
          <div class="toast-header">
            <strong class="me-auto">{{ toast.title }}</strong>
            <button type="button" class="btn-close" (click)="closeToast(toast.id)" [attr.aria-label]="translationService.translate('common.close') || ''">
              {{ translationService.translate('common.close') || '' }}
            </button>
          </div>
          <div class="toast-body">
            {{ toast.message }}
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="!profile" class="d-flex justify-content-center my-5">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">{{ translationService.translate('common.loading') || 'جارٍ التحميل' }}</span>
        </div>
      </div>

      <!-- Profile Content -->
      <div *ngIf="profile" class="profile-content">
        <!-- Profile Header -->
        <div class="profile-header card shadow-sm mb-4">
          <div class="card-body profile-header-content d-flex flex-column flex-md-row align-items-center">
            <div class="profile-image-container me-md-4 mb-3 mb-md-0 position-relative">
              <img *ngIf="profile.profileImage"
                   [src]="profile.profileImage"
                   [alt]="translationService.translate('profile.profileImage') || 'صورة الملف الشخصي'"
                   class="profile-image rounded-circle">
              <img *ngIf="!profile.profileImage"
                   src="/assets/default-profile.png"
                   [alt]="translationService.translate('profile.defaultImage') || 'الصورة الافتراضية'"
                   class="profile-image rounded-circle">
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark" style="margin-bottom: 20px;">
                {{ translationService.translate('profile.lowLectureCount') || 'عدد مرات التقصير مع الطلاب' }}: {{ lowLectureWeekCount }}
              </span>
            </div>
            <div class="profile-details-container flex-grow-1">
              <h2 class="profile-name mb-3">{{ profile.name || (translationService.translate('profile.notSpecified') || 'غير محدد') }}</h2>
              <button class="btn btn-outline-primary change-image-btn mb-3"
                      (click)="changeImage()"
                      [attr.aria-label]="translationService.translate('profile.changeImage') || 'تغيير الصورة'">
                {{ translationService.translate('profile.changeImage') || 'تغيير الصورة' }}
              </button>

              <!-- Upload Section -->
              <div *ngIf="showUploadField" class="upload-section">
                <input type="file"
                       id="profileImageInput"
                       class="form-control mb-2"
                       accept="image/jpeg,image/png,image/gif,image/webp"
                       (change)="onFileSelected($event)"
                       [attr.aria-label]="translationService.translate('profile.selectImage') || 'اختيار الصورة'">
                <button [disabled]="isUploading || !selectedFile"
                        class="btn btn-primary"
                        (click)="uploadProfileImage()"
                        [attr.aria-label]="translationService.translate('profile.uploadImage') || 'تحميل الصورة'">
                  <span *ngIf="isUploading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  {{ isUploading ? (translationService.translate('profile.uploading') || 'جارٍ التحميل') : (translationService.translate('profile.uploadImage') || 'تحميل الصورة') }}
                </button>
              </div>

              <!-- Admin Message -->
              <div *ngIf="activeMessage" class="message-section mt-3">
                <h4 class="message-title">{{ translationService.translate('profile.adminMessage') || 'رسالة الإدارة' }}</h4>
                <p class="message-content">{{ activeMessage.content }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs d-flex flex-wrap justify-content-center mb-4">
          <button class="nav-tab btn btn-outline-secondary m-1"
                  [ngClass]="{'active': activeSection === 'profile'}"
                  (click)="setActiveSection('profile')"
                  [attr.aria-label]="translationService.translate('profile.profileTab') || 'الملف الشخصي'">
            {{ translationService.translate('profile.profileTab') || 'الملف الشخصي' }}
          </button>
          <button class="nav-tab btn btn-outline-secondary m-1"
                  [ngClass]="{'active': activeSection === 'students'}"
                  (click)="setActiveSection('students')"
                  [attr.aria-label]="translationService.translate('profile.studentsTab') || 'الطلاب'">
            {{ translationService.translate('profile.studentsTab') || 'الطلاب' }}
          </button>
          <button class="nav-tab btn btn-outline-secondary m-1"
                  [ngClass]="{'active': activeSection === 'meetings'}"
                  (click)="setActiveSection('meetings')"
                  [attr.aria-label]="translationService.translate('profile.meetingsTab') || 'الاجتماعات'">
            {{ translationService.translate('profile.meetingsTab') || 'الاجتماعات' }}
          </button>
          <button class="nav-tab btn btn-outline-secondary m-1"
                  [ngClass]="{'active': activeSection === 'add-lecture'}"
                  (click)="setActiveSection('add-lecture')"
                  [attr.aria-label]="translationService.translate('profile.addLectureTab') || 'إضافة محاضرة'">
            {{ translationService.translate('profile.addLectureTab') || 'إضافة محاضرة' }}
          </button>
          <button class="nav-tab btn btn-outline-secondary m-1"
                  [ngClass]="{'active': activeSection === 'pdf-request'}"
                  (click)="setActiveSection('pdf-request')"
                  [attr.aria-label]="translationService.translate('profile.pdfRequestTab') || 'طلب PDF'">
            {{ translationService.translate('profile.pdfRequestTab') || 'طلب PDF' }}
          </button>
          <button class="nav-tab btn btn-outline-secondary m-1"
                  (click)="openPasswordModal()"
                  [attr.aria-label]="translationService.translate('profile.changePasswordTab') || 'تغيير كلمة المرور'">
            {{ translationService.translate('profile.changePasswordTab') || 'تغيير كلمة المرور' }}
          </button>
        </div>

        <!-- Profile Section -->
        <div id="profile-section" *ngIf="activeSection === 'profile'" class="card shadow-sm">
          <div class="card-header">
            <h3 class="mb-0">{{ translationService.translate('profile.profileTab') || 'الملف الشخصي' }}</h3>
          </div>
          <div class="card-body">
            <!-- Low Lecture Warning -->
            <div *ngIf="showLectureWarning" class="alert alert-warning" role="alert">
              {{ translationService.translate('profile.lowLectureWarning') || 'تحذير: عدد المحاضرات منخفض' }}
            </div>

            <!-- Profile Information -->
            <div class="row">
              <div class="col-md-6">
                <dl class="row mb-0">
                  <dt class="col-sm-4">{{ translationService.translate('profile.name') || 'الاسم' }}:</dt>
                  <dd class="col-sm-8">{{ profile.name || (translationService.translate('profile.notSpecified') || 'غير محدد') }}</dd>
                  <dt class="col-sm-4">{{ translationService.translate('profile.email') || 'البريد الإلكتروني' }}:</dt>
                  <dd class="col-sm-8">{{ profile.email || (translationService.translate('profile.notSpecified') || 'غير محدد') }}</dd>
                  <dt class="col-sm-4">{{ translationService.translate('profile.phone') || 'الهاتف' }}:</dt>
                  <dd class="col-sm-8">{{ profile.phone || (translationService.translate('profile.notSpecified') || 'غير محدد') }}</dd>
                  <dt class="col-sm-4">{{ translationService.translate('profile.address') || 'العنوان' }}:</dt>
                  <dd class="col-sm-8">{{ profile.address || (translationService.translate('profile.notSpecified') || 'غير محدد') }}</dd>
                </dl>
              </div>
              <div class="col-md-6">
                <dl class="row mb-0">
                  <dt class="col-sm-4">{{ translationService.translate('profile.academicSpecialization') || 'التخصص الأكاديمي' }}:</dt>
                  <dd class="col-sm-8">{{ profile.academicSpecialization || (translationService.translate('profile.notSpecified') || 'غير محدد') }}</dd>
                  <dt class="col-sm-4">{{ translationService.translate('profile.volunteerHours') || 'ساعات التطوع' }}:</dt>
                  <dd class="col-sm-8">{{ profile.volunteerHours || (translationService.translate('profile.notSpecified') || 'غير محدد') }}</dd>
                  <dt class="col-sm-4">{{ translationService.translate('profile.numberOfStudents') || 'عدد الطلاب' }}:</dt>
                  <dd class="col-sm-8">{{ profile.numberOfStudents || (translationService.translate('profile.notSpecified') || 'غير محدد') }}</dd>
                  <dt class="col-sm-4">{{ translationService.translate('profile.subjects') || 'المواد' }}:</dt>
                  <dd class="col-sm-8">{{ profile.subjects?.length ? profile.subjects.join(', ') : (translationService.translate('profile.notSpecified') || 'غير محدد') }}</dd>
                  <dt class="col-sm-4">{{ translationService.translate('profile.lectureCount') || 'عدد المحاضرات' }}:</dt>
                  <dd class="col-sm-8">{{ profile.lectureCount || (translationService.translate('profile.notSpecified') || 'غير محدد') }}</dd>
                </dl>
              </div>
            </div>
          </div>
        </div>

        <!-- Add Lecture Section -->
        <div id="add-lecture-section" *ngIf="activeSection === 'add-lecture'" class="card shadow-sm mt-4">
          <div class="card-header">
            <h3 class="mb-0">{{ translationService.translate('profile.addLectureTab') || 'إضافة محاضرة' }}</h3>
          </div>
          <div class="card-body">
            <div *ngIf="!profile?.students?.length" class="alert alert-warning mt-3" role="alert">
              {{ translationService.translate('profile.noStudentsAvailable') || 'لا يوجد طلاب متاحون' }}
            </div>
            <form [formGroup]="lectureForm" (ngSubmit)="onSubmitLecture()" class="row g-3">
              <div class="col-md-4 col-sm-6">
                <div class="form-floating">
                  <select id="lectureStudentEmail"
                          formControlName="studentEmail"
                          class="form-control"
                          [class.is-invalid]="lectureForm.get('studentEmail')?.invalid && lectureForm.get('studentEmail')?.touched"
                          [attr.aria-label]="translationService.translate('profile.lectureStudentEmail') || 'بريد الطالب الإلكتروني'"
                          [attr.aria-describedby]="lectureForm.get('studentEmail')?.invalid && lectureForm.get('studentEmail')?.touched ? 'studentEmailError' : null">
                    <option value="" disabled>{{ translationService.translate('profile.selectStudent') || 'اختر الطالب' }}</option>
                    <option *ngFor="let student of profile.students" [value]="student.email">
                      {{ student.email }} ({{ student.name }})
                    </option>
                  </select>
                  <label for="lectureStudentEmail">{{ translationService.translate('profile.lectureStudentEmail') || 'بريد الطالب الإلكتروني' }}</label>
                  <div *ngIf="lectureForm.get('studentEmail')?.invalid && lectureForm.get('studentEmail')?.touched"
                       id="studentEmailError"
                       class="invalid-feedback">
                    <span *ngIf="lectureForm.get('studentEmail')?.errors?.['required']">
                      {{ translationService.translate('profile.validation.studentEmail.required') || 'بريد الطالب مطلوب' }}
                    </span>
                    <span *ngIf="lectureForm.get('studentEmail')?.errors?.['email']">
                      {{ translationService.translate('profile.validation.studentEmail.email') || 'بريد إلكتروني غير صالح' }}
                    </span>
                    <span *ngIf="lectureForm.get('studentEmail')?.errors?.['invalidStudent']">
                      {{ translationService.translate('profile.validation.studentEmail.invalid') || 'الطالب غير صالح' }}
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-md-4 col-sm-6">
                <div class="form-floating">
                  <select id="lectureSubject"
                          formControlName="subject"
                          class="form-control"
                          [class.is-invalid]="lectureForm.get('subject')?.invalid && lectureForm.get('subject')?.touched"
                          [attr.aria-label]="translationService.translate('profile.lectureSubject') || 'مادة المحاضرة'"
                          [attr.aria-describedby]="lectureForm.get('subject')?.invalid && lectureForm.get('subject')?.touched ? 'subjectError' : null">
                    <option value="" disabled>{{ translationService.translate('profile.selectSubject') || 'اختر المادة' }}</option>
                    <option *ngFor="let subject of subjectKeys; let i = index" [value]="subject">
                      {{ getTranslatedSubjects()[i] }}
                    </option>
                  </select>
                  <label for="lectureSubject">{{ translationService.translate('profile.lectureSubject') || 'مادة المحاضرة' }}</label>
                  <div *ngIf="lectureForm.get('subject')?.invalid && lectureForm.get('subject')?.touched"
                       id="subjectError"
                       class="invalid-feedback">
                    <span *ngIf="lectureForm.get('subject')?.errors?.['required']">
                      {{ translationService.translate('profile.validation.subject.required') || 'المادة مطلوبة' }}
                    </span>
                    <span *ngIf="lectureForm.get('subject')?.errors?.['invalidSubject']">
                      {{ translationService.translate('profile.validation.subject.invalid') || 'المادة غير صالحة' }}
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-md-4 col-sm-6">
                <div class="form-floating">
                  <input id="lectureDate"
                         formControlName="date"
                         type="date"
                         class="form-control"
                         [class.is-invalid]="lectureForm.get('date')?.invalid && lectureForm.get('date')?.touched"
                         [attr.aria-label]="translationService.translate('profile.lectureDate') || 'تاريخ المحاضرة'"
                         [attr.aria-describedby]="lectureForm.get('date')?.invalid && lectureForm.get('date')?.touched ? 'dateError' : null"
                         [max]="getMaxDate()" />
                  <label for="lectureDate">{{ translationService.translate('profile.lectureDate') || 'تاريخ المحاضرة' }}</label>
                  <div *ngIf="lectureForm.get('date')?.invalid && lectureForm.get('date')?.touched"
                       id="dateError"
                       class="invalid-feedback">
                    <span *ngIf="lectureForm.get('date')?.errors?.['required']">
                      {{ translationService.translate('profile.validation.date.required') || 'التاريخ مطلوب' }}
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-md-4 col-sm-6">
                <div class="form-floating">
                  <input id="lectureDuration"
                         formControlName="duration"
                         type="number"
                         class="form-control"
                         min="1"
                         [class.is-invalid]="lectureForm.get('duration')?.invalid && lectureForm.get('duration')?.touched"
                         [attr.aria-label]="translationService.translate('profile.lectureDuration') || 'مدة المحاضرة'"
                         [attr.aria-describedby]="lectureForm.get('duration')?.invalid && lectureForm.get('duration')?.touched ? 'durationError' : null"
                         placeholder="{{ translationService.translate('profile.enterDuration') || 'أدخل المدة بالدقائق' }}" />
                  <label for="lectureDuration">{{ translationService.translate('profile.lectureDuration') || 'مدة المحاضرة' }}</label>
                  <div *ngIf="lectureForm.get('duration')?.invalid && lectureForm.get('duration')?.touched"
                       id="durationError"
                       class="invalid-feedback">
                    <span *ngIf="lectureForm.get('duration')?.errors?.['required']">
                      {{ translationService.translate('profile.validation.duration.required') || 'المدة مطلوبة' }}
                    </span>
                    <span *ngIf="lectureForm.get('duration')?.errors?.['min']">
                      {{ translationService.translate('profile.validation.duration.min') || 'المدة يجب أن تكون أكبر من صفر' }}
                    </span>
                    <span *ngIf="lectureForm.get('duration')?.errors?.['pattern']">
                      {{ translationService.translate('profile.validation.duration.pattern') || 'المدة يجب أن تكون رقمًا صحيحًا' }}
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-md-4 col-sm-6">
                <div class="form-floating">
                  <input id="lectureLink"
                         formControlName="link"
                         type="url"
                         class="form-control"
                         [class.is-invalid]="lectureForm.get('link')?.invalid && lectureForm.get('link')?.touched"
                         [attr.aria-label]="translationService.translate('profile.lectureLink') || 'رابط المحاضرة'"
                         [attr.aria-describedby]="lectureForm.get('link')?.invalid && lectureForm.get('link')?.touched ? 'linkError' : null"
                         placeholder="https://example.com" />
                  <label for="lectureLink">{{ translationService.translate('profile.lectureLink') || 'رابط المحاضرة' }}</label>
                  <div *ngIf="lectureForm.get('link')?.invalid && lectureForm.get('link')?.touched"
                       id="linkError"
                       class="invalid-feedback">
                    <span *ngIf="lectureForm.get('link')?.errors?.['required']">
                      {{ translationService.translate('profile.validation.link.required') || 'الرابط مطلوب' }}
                    </span>
                    <span *ngIf="lectureForm.get('link')?.errors?.['pattern']">
                      {{ translationService.translate('profile.validation.link.pattern') || 'رابط غير صالح' }}
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-md-4 col-sm-6">
                <div class="form-floating">
                  <input id="lectureName"
                         formControlName="name"
                         type="text"
                         class="form-control"
                         [class.is-invalid]="lectureForm.get('name')?.invalid && lectureForm.get('name')?.touched"
                         [attr.aria-label]="translationService.translate('profile.lectureName') || 'اسم المحاضرة'"
                         [attr.aria-describedby]="lectureForm.get('name')?.invalid && lectureForm.get('name')?.touched ? 'nameError' : null" />
                  <label for="lectureName">{{ translationService.translate('profile.lectureName') || 'اسم المحاضرة' }}</label>
                  <div *ngIf="lectureForm.get('name')?.invalid && lectureForm.get('name')?.touched"
                       id="nameError"
                       class="invalid-feedback">
                    <span *ngIf="lectureForm.get('name')?.errors?.['required']">
                      {{ translationService.translate('profile.validation.name.required') || 'الاسم مطلوب' }}
                    </span>
                    <span *ngIf="lectureForm.get('name')?.errors?.['minlength']">
                      {{ translationService.translate('profile.validation.name.minlength') || 'الاسم قصير جدًا' }}
                    </span>
                    <span *ngIf="lectureForm.get('name')?.errors?.['maxlength']">
                      {{ translationService.translate('profile.validation.name.maxlength') || 'الاسم طويل جدًا' }}
                    </span>
                  </div>
                </div>
              </div>

              <div class="d-flex justify-content-center mt-3 col-12">
                <button type="submit"
                        class="btn btn-success"
                        [disabled]="isUploadingLecture || lectureForm.invalid || !profile.students?.length"
                        [attr.aria-label]="translationService.translate('profile.uploadLecture') || 'تحميل المحاضرة'">
                  <span *ngIf="isUploadingLecture" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  {{ isUploadingLecture ?
                    (translationService.translate('profile.uploadingLecture') || 'جارٍ تحميل المحاضرة') :
                    (translationService.translate('profile.uploadLecture') || 'تحميل المحاضرة') }}
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Students Section -->
        <div id="students-section" *ngIf="activeSection === 'students'" class="card shadow-sm mt-4">
          <div class="card-header">
            <h3 class="mb-0">{{ translationService.translate('profile.studentsTitle') || 'الطلاب' }}</h3>
          </div>
          <div class="card-body">
            <div *ngIf="profile.numberOfStudents > 0 && (!profile.students || profile.students.length === 0)"
                 class="alert alert-warning"
                 role="alert">
              {{ translationService.translate('profile.studentDataMismatch') || 'عدم تطابق بيانات الطلاب' }}
            </div>

            <div *ngIf="profile.numberOfStudents === 0 && (!profile.students || profile.students.length === 0)"
                 class="alert alert-info"
                 role="alert">
              {{ translationService.translate('profile.noStudents') || 'لا يوجد طلاب' }}
            </div>

            <div class="table-responsive" *ngIf="profile.students && profile.students.length > 0">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th scope="col">{{ translationService.translate('profile.studentName') || 'اسم الطالب' }}</th>
                    <th scope="col">{{ translationService.translate('profile.studentEmail') || 'بريد الطالب الإلكتروني' }}</th>
                    <th scope="col">{{ translationService.translate('profile.studentPhone') || 'هاتف الطالب' }}</th>
                    <th scope="col">{{ translationService.translate('profile.studentGrade') || 'الصف الدراسي' }}</th>
                    <th scope="col">{{ translationService.translate('profile.studentSubjects') || 'مواد الطالب' }}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let student of profile.students">
                    <td>{{ student.name || (translationService.translate('profile.notAvailable') || 'غير متاح') }}</td>
                    <td>{{ student.email || (translationService.translate('profile.notAvailable') || 'غير متاح') }}</td>
                    <td>{{ student.phone || (translationService.translate('profile.notAvailable') || 'غير متاح') }}</td>
                    <td>{{ student.grade || (translationService.translate('profile.notSpecified') || 'غير محدد') }}</td>
                    <td>{{ getStudentSubjects(student) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Meetings Section -->
        <div id="meetings-section" *ngIf="activeSection === 'meetings'" class="card shadow-sm mt-4 mb-4">
          <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
            <h3 class="mb-0">{{ translationService.translate('profile.meetingsTitle') || 'الاجتماعات' }}</h3>
            <button class="btn btn-primary btn-sm mt-2 mt-md-0"
                    [disabled]="isAddingMeeting"
                    (click)="openMeetingModal()"
                    [attr.aria-label]="translationService.translate('profile.addMeeting') || 'إضافة اجتماع'">
              <i class="fas fa-plus me-2"></i>
              {{ translationService.translate('profile.addMeeting') || 'إضافة اجتماع' }}
            </button>
          </div>
          <div class="card-body">
            <!-- Calendar -->
            <!-- <div class="calendar-container">
              <full-calendar [options]="calendarOptions"></full-calendar>
            </div> -->

            <!-- Meetings List -->
            <div *ngIf="profile.meetings && profile.meetings.length > 0" class="mt-4 meetings-list">
              <h4>{{ translationService.translate('profile.meetingsList') || 'قائمة الاجتماعات' }}</h4>
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th scope="col">{{ translationService.translate('profile.meetingTitle') || 'عنوان الاجتماع' }}</th>
                      <th scope="col">{{ translationService.translate('profile.meetingDate') || 'تاريخ الاجتماع' }}</th>
                      <th scope="col">{{ translationService.translate('profile.meetingStartTime') || 'وقت البدء' }}</th>
                      <th scope="col">{{ translationService.translate('profile.meetingEndTime') || 'وقت الانتهاء' }}</th>
                      <th scope="col">{{ translationService.translate('profile.actions') || 'الإجراءات' }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let meeting of profile.meetings">
                      <td>{{ meeting.title || (translationService.translate('profile.notSpecified') || 'غير محدد') }}</td>
                      <td>{{ meeting.date || (translationService.translate('profile.notSpecified') || 'غير محدد') }}</td>
                      <td>{{ meeting.startTime || (translationService.translate('profile.notSpecified') || 'غير محدد') }}</td>
                      <td>{{ meeting.endTime || (translationService.translate('profile.notSpecified') || 'غير محدد') }}</td>
                      <td>
                        <button *ngIf="meeting.id" class="btn btn-danger btn-sm"
                                [disabled]="isDeletingMeeting[meeting.id]"
                                (click)="deleteMeeting(meeting.id)"
                                [attr.aria-label]="translationService.translate('profile.deleteMeeting') || 'حذف الاجتماع'">
                          <span *ngIf="isDeletingMeeting[meeting.id]" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                          {{ isDeletingMeeting[meeting.id] ?
                            (translationService.translate('profile.deleting') || 'جارٍ الحذف') :
                            (translationService.translate('profile.deleteMeeting') || 'حذف الاجتماع') }}
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div *ngIf="!profile.meetings || profile.meetings.length === 0" class="alert alert-info mt-4" role="alert">
              {{ translationService.translate('profile.noMeetings') || 'لا يوجد اجتماعات' }}
            </div>
          </div>
        </div>

        <!-- PDF Request Section -->
        <div id="pdf-request-section" *ngIf="activeSection === 'pdf-request'" class="card shadow-sm mt-4">
          <div class="card-header">
            <h3 class="mb-0">{{ translationService.translate('profile.pdfRequestTab') || 'طلب PDF' }}</h3>
          </div>
          <div class="card-body">
            <form [formGroup]="pdfRequestForm" (ngSubmit)="uploadPdfRequest()" class="row g-3">
              <div class="col-md-6 col-sm-12">
                <div class="form-floating">
                  <input id="pdfTitle"
                         formControlName="title"
                         type="text"
                         class="form-control"
                         [class.is-invalid]="pdfRequestForm.get('title')?.invalid && pdfRequestForm.get('title')?.touched"
                         [attr.aria-label]="translationService.translate('profile.pdfTitle') || 'عنوان المستند'"
                         [attr.aria-describedby]="pdfRequestForm.get('title')?.invalid && pdfRequestForm.get('title')?.touched ? 'titleError' : null" />
                  <label for="pdfTitle">{{ translationService.translate('profile.pdfTitle') || 'عنوان المستند' }}</label>
                  <div *ngIf="pdfRequestForm.get('title')?.invalid && pdfRequestForm.get('title')?.touched"
                       id="titleError"
                       class="invalid-feedback">
                    <span *ngIf="pdfRequestForm.get('title')?.errors?.['required']">
                      {{ translationService.translate('profile.validation.title.required') || 'العنوان مطلوب' }}
                    </span>
                    <span *ngIf="pdfRequestForm.get('title')?.errors?.['minlength']">
                      {{ translationService.translate('profile.validation.title.minlength') || 'العنوان قصير جدًا' }}
                    </span>
                    <span *ngIf="pdfRequestForm.get('title')?.errors?.['maxlength']">
                      {{ translationService.translate('profile.validation.title.maxlength') || 'العنوان طويل جدًا' }}
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-md-6 col-sm-12">
                <div class="form-floating">
                  <input id="pdfCreatorName"
                         formControlName="creatorName"
                         type="text"
                         class="form-control"
                         [class.is-invalid]="pdfRequestForm.get('creatorName')?.invalid && pdfRequestForm.get('creatorName')?.touched"
                         [attr.aria-label]="translationService.translate('profile.pdfCreatorName') || 'اسم المنشئ'"
                         [attr.aria-describedby]="pdfRequestForm.get('creatorName')?.invalid && pdfRequestForm.get('creatorName')?.touched ? 'creatorNameError' : null" />
                  <label for="pdfCreatorName">{{ translationService.translate('profile.pdfCreatorName') || 'اسم المنشئ' }}</label>
                  <div *ngIf="pdfRequestForm.get('creatorName')?.invalid && pdfRequestForm.get('creatorName')?.touched"
                       id="creatorNameError"
                       class="invalid-feedback">
                    <span *ngIf="pdfRequestForm.get('creatorName')?.errors?.['required']">
                      {{ translationService.translate('profile.validation.creatorName.required') || 'اسم المنشئ مطلوب' }}
                    </span>
                    <span *ngIf="pdfRequestForm.get('creatorName')?.errors?.['minlength']">
                      {{ translationService.translate('profile.validation.creatorName.minlength') || 'اسم المنشئ قصير جدًا' }}
                    </span>
                    <span *ngIf="pdfRequestForm.get('creatorName')?.errors?.['maxlength']">
                      {{ translationService.translate('profile.validation.creatorName.maxlength') || 'اسم المنشئ طويل جدًا' }}
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-md-6 col-sm-12">
                <div class="form-floating">
                  <textarea id="pdfDescription"
                            formControlName="description"
                            class="form-control"
                            style="height: 100px;"
                            [class.is-invalid]="pdfRequestForm.get('description')?.invalid && pdfRequestForm.get('description')?.touched"
                            [attr.aria-label]="translationService.translate('profile.pdfDescription') || 'وصف المستند'"
                            [attr.aria-describedby]="pdfRequestForm.get('description')?.invalid && pdfRequestForm.get('description')?.touched ? 'descriptionError' : null"></textarea>
                  <label for="pdfDescription">{{ translationService.translate('profile.pdfDescription') || 'وصف المستند' }}</label>
                  <div *ngIf="pdfRequestForm.get('description')?.invalid && pdfRequestForm.get('description')?.touched"
                       id="descriptionError"
                       class="invalid-feedback">
                    <span *ngIf="pdfRequestForm.get('description')?.errors?.['required']">
                      {{ translationService.translate('profile.validation.description.required') || 'الوصف مطلوب' }}
                    </span>
                    <span *ngIf="pdfRequestForm.get('description')?.errors?.['minlength']">
                      {{ translationService.translate('profile.validation.description.minlength') || 'الوصف قصير جدًا' }}
                    </span>
                    <span *ngIf="pdfRequestForm.get('description')?.errors?.['maxlength']">
                      {{ translationService.translate('profile.validation.description.maxlength') || 'الوصف طويل جدًا' }}
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-md-6 col-sm-12">
                <div class="form-floating">
                  <select id="pdfSubject"
                          formControlName="subject"
                          class="form-control"
                          [class.is-invalid]="pdfRequestForm.get('subject')?.invalid && pdfRequestForm.get('subject')?.touched"
                          [attr.aria-label]="translationService.translate('profile.pdfSubject') || 'مادة المستند'"
                          [attr.aria-describedby]="pdfRequestForm.get('subject')?.invalid && pdfRequestForm.get('subject')?.touched ? 'subjectError' : null">
                    <option value="" disabled>{{ translationService.translate('profile.selectSubject') || 'اختر المادة' }}</option>
                    <option *ngFor="let subject of subjectKeys; let i = index" [value]="subject">
                      {{ getTranslatedSubjects()[i] }}
                    </option>
                  </select>
                  <label for="pdfSubject">{{ translationService.translate('profile.pdfSubject') || 'مادة المستند' }}</label>
                  <div *ngIf="pdfRequestForm.get('subject')?.invalid && pdfRequestForm.get('subject')?.touched"
                       id="subjectError"
                       class="invalid-feedback">
                    <span *ngIf="pdfRequestForm.get('subject')?.errors?.['required']">
                      {{ translationService.translate('profile.validation.subject.required') || 'المادة مطلوبة' }}
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-md-6 col-sm-12">
                <div class="form-floating">
                  <select id="pdfSemester"
                          formControlName="semester"
                          class="form-control"
                          [class.is-invalid]="pdfRequestForm.get('semester')?.invalid && pdfRequestForm.get('semester')?.touched"
                          [attr.aria-label]="translationService.translate('profile.pdfSemester') || 'الفصل الدراسي'"
                          [attr.aria-describedby]="pdfRequestForm.get('semester')?.invalid && pdfRequestForm.get('semester')?.touched ? 'semesterError' : null">
                    <option value="" disabled>{{ translationService.translate('profile.selectSemester') || 'اختر الفصل الدراسي' }}</option>
                    <option *ngFor="let semester of getTranslatedSemesters()" [value]="semester">
                      {{ semester }}
                    </option>
                  </select>
                  <label for="pdfSemester">{{ translationService.translate('profile.pdfSemester') || 'الفصل الدراسي' }}</label>
                  <div *ngIf="pdfRequestForm.get('semester')?.invalid && pdfRequestForm.get('semester')?.touched"
                       id="semesterError"
                       class="invalid-feedback">
                    <span *ngIf="pdfRequestForm.get('semester')?.errors?.['required']">
                      {{ translationService.translate('profile.validation.semester.required') || 'الفصل الدراسي مطلوب' }}
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-md-6 col-sm-12">
                <div class="form-floating">
                  <select id="pdfCountry"
                          formControlName="country"
                          class="form-control"
                          [class.is-invalid]="pdfRequestForm.get('country')?.invalid && pdfRequestForm.get('country')?.touched"
                          [attr.aria-label]="translationService.translate('profile.pdfCountry') || 'الدولة'"
                          [attr.aria-describedby]="pdfRequestForm.get('country')?.invalid && pdfRequestForm.get('country')?.touched ? 'countryError' : null">
                    <option value="" disabled>{{ translationService.translate('profile.selectCountry') || 'اختر الدولة' }}</option>
                    <option *ngFor="let country of getTranslatedCountries()" [value]="country">
                      {{ country }}
                    </option>
                  </select>
                  <label for="pdfCountry">{{ translationService.translate('profile.pdfCountry') || 'الدولة' }}</label>
                  <div *ngIf="pdfRequestForm.get('country')?.invalid && pdfRequestForm.get('country')?.touched"
                       id="countryError"
                       class="invalid-feedback">
                    <span *ngIf="pdfRequestForm.get('country')?.errors?.['required']">
                      {{ translationService.translate('profile.validation.country.required') || 'الدولة مطلوبة' }}
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-md-6 col-sm-12">
                <div class="form-floating">
                  <select id="pdfAcademicLevel"
                          formControlName="academicLevel"
                          class="form-control"
                          [class.is-invalid]="pdfRequestForm.get('academicLevel')?.invalid && pdfRequestForm.get('academicLevel')?.touched"
                          [attr.aria-label]="translationService.translate('profile.pdfAcademicLevel') || 'المستوى الأكاديمي'"
                          [attr.aria-describedby]="pdfRequestForm.get('academicLevel')?.invalid && pdfRequestForm.get('academicLevel')?.touched ? 'academicLevelError' : null">
                    <option value="" disabled>{{ translationService.translate('profile.selectAcademicLevel') || 'اختر المستوى الأكاديمي' }}</option>
                    <option *ngFor="let level of getTranslatedAcademicLevels()" [value]="level">
                      {{ level }}
                    </option>
                  </select>
                  <label for="pdfAcademicLevel">{{ translationService.translate('profile.pdfAcademicLevel') || 'المستوى الأكاديمي' }}</label>
                  <div *ngIf="pdfRequestForm.get('academicLevel')?.invalid && pdfRequestForm.get('academicLevel')?.touched"
                       id="academicLevelError"
                       class="invalid-feedback">
                    <span *ngIf="pdfRequestForm.get('academicLevel')?.errors?.['required']">
                      {{ translationService.translate('profile.validation.academicLevel.required') || 'المستوى الأكاديمي مطلوب' }}
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-12">
                <div class="form-group">
                  <label for="pdfFileInput">{{ translationService.translate('profile.pdfFile') || 'ملف PDF' }}</label>
                  <input type="file"
                         id="pdfFileInput"
                         class="form-control"
                         accept="application/pdf"
                         (change)="onPdfFileSelected($event)"
                         [attr.aria-label]="translationService.translate('profile.selectPdfFile') || 'اختيار ملف PDF'">
                </div>
              </div>

              <div class="d-flex justify-content-center mt-3 col-12">
                <button type="submit"
                        class="btn btn-success"
                        [disabled]="isUploadingPdfRequest || pdfRequestForm.invalid || !selectedPdfFile"
                        [attr.aria-label]="translationService.translate('profile.uploadPdfRequest') || 'تحميل طلب PDF'">
                  <span *ngIf="isUploadingPdfRequest" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  {{ isUploadingPdfRequest ?
                    (translationService.translate('profile.uploadingPdfRequest') || 'جارٍ تحميل طلب PDF') :
                    (translationService.translate('profile.uploadPdfRequest') || 'تحميل طلب PDF') }}
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Password Modal -->
        <div *ngIf="showPasswordModal" class="modal fade show d-block" tabindex="-1" role="dialog" aria-labelledby="passwordModalLabel">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="passwordModalLabel">{{ translationService.translate('profile.changePassword') || 'تغيير كلمة المرور' }}</h5>
                <button type="button" class="btn-close" (click)="closePasswordModal()" [attr.aria-label]="translationService.translate('common.close') || ''">
                  {{ translationService.translate('common.close') || '' }}
                </button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label for="currentPassword" class="form-label">{{ translationService.translate('profile.currentPassword') || 'كلمة المرور الحالية' }}</label>
                  <input type="password"
                         id="currentPassword"
                         class="form-control"
                         [(ngModel)]="currentPassword"
                         [class.is-invalid]="errorCode === 'missing_fields' || errorCode === 'same_password'"
                         [attr.aria-label]="translationService.translate('profile.currentPassword') || 'كلمة المرور الحالية'"
                         [attr.aria-describedby]="errorCode ? 'currentPasswordError' : null">
                  <div *ngIf="errorCode === 'missing_fields' || errorCode === 'same_password'"
                       id="currentPasswordError"
                       class="invalid-feedback">
                    {{ translationService.translate('profile.' + errorCode) || 'خطأ في كلمة المرور' }}
                  </div>
                </div>
                <div class="mb-3">
                  <label for="newPassword" class="form-label">{{ translationService.translate('profile.newPassword') || 'كلمة المرور الجديدة' }}</label>
                  <input type="password"
                         id="newPassword"
                         class="form-control"
                         [(ngModel)]="newPassword"
                         [class.is-invalid]="errorCode === 'missing_fields' || errorCode === 'same_password' || errorCode === 'password_too_short'"
                         [attr.aria-label]="translationService.translate('profile.newPassword') || 'كلمة المرور الجديدة'"
                         [attr.aria-describedby]="errorCode ? 'newPasswordError' : null">
                  <div *ngIf="errorCode === 'missing_fields' || errorCode === 'same_password' || errorCode === 'password_too_short'"
                       id="newPasswordError"
                       class="invalid-feedback">
                    {{ translationService.translate('profile.' + errorCode) || 'خطأ في كلمة المرور الجديدة' }}
                  </div>
                </div>
                <div class="text-center">
                  <a href="javascript:void(0)" (click)="navigateToForgotPassword()" [attr.aria-label]="translationService.translate('profile.forgotPassword') || 'نسيت كلمة المرور'">
                    {{ translationService.translate('profile.forgotPassword') || 'نسيت كلمة المرور' }}
                  </a>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closePasswordModal()" [attr.aria-label]="translationService.translate('common.cancel') || 'إلغاء'">
                  {{ translationService.translate('common.cancel') || 'إلغاء' }}
                </button>
                <button type="button" class="btn btn-primary" (click)="changePassword()" [attr.aria-label]="translationService.translate('profile.changePassword') || 'تغيير كلمة المرور'">
                  {{ translationService.translate('profile.changePassword') || 'تغيير كلمة المرور' }}
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Meeting Modal -->
        <div *ngIf="showMeetingModal" class="modal fade show d-block" tabindex="-1" role="dialog" aria-labelledby="meetingModalLabel">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="meetingModalLabel">{{ translationService.translate('profile.addMeeting') || 'إضافة اجتماع' }}</h5>
                <button type="button" class="btn-close" (click)="closeMeetingModal()" [attr.aria-label]="translationService.translate('common.close') || ''">
                  {{ translationService.translate('common.close') || '' }}
                </button>
              </div>
              <div class="modal-body">
                <form [formGroup]="meetingForm" (ngSubmit)="addMeeting()" class="row g-2">
                  <div class="col-12 mb-2">
                    <div class="form-floating">
                      <input id="meetingTitle"
                             formControlName="title"
                             type="text"
                             class="form-control"
                             [class.is-invalid]="meetingForm.get('title')?.invalid && meetingForm.get('title')?.touched"
                             [attr.aria-label]="translationService.translate('profile.meetingTitle') || 'عنوان الاجتماع'"
                             [attr.aria-describedby]="meetingForm.get('title')?.invalid && meetingForm.get('title')?.touched ? 'titleError' : null" />
                      <label for="meetingTitle">{{ translationService.translate('profile.meetingTitle') || 'عنوان الاجتماع' }}</label>
                      <div *ngIf="meetingForm.get('title')?.invalid && meetingForm.get('title')?.touched"
                           id="titleError"
                           class="invalid-feedback">
                        <span *ngIf="meetingForm.get('title')?.errors?.['required']">
                          {{ translationService.translate('profile.validation.title.required') || 'العنوان مطلوب' }}
                        </span>
                        <span *ngIf="meetingForm.get('title')?.errors?.['minlength']">
                          {{ translationService.translate('profile.validation.title.minlength') || 'العنوان قصير جدًا' }}
                        </span>
                        <span *ngIf="meetingForm.get('title')?.errors?.['maxlength']">
                          {{ translationService.translate('profile.validation.title.maxlength') || 'العنوان طويل جدًا' }}
                        </span>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 mb-2">
                    <div class="form-floating">
                      <input id="meetingDate"
                             formControlName="date"
                             type="date"
                             class="form-control"
                             [class.is-invalid]="(meetingForm.get('date')?.invalid && meetingForm.get('date')?.touched) || meetingForm.errors?.['invalidDate']"
                             [attr.aria-label]="translationService.translate('profile.meetingDate') || 'تاريخ الاجتماع'"
                             [attr.aria-describedby]="(meetingForm.get('date')?.invalid && meetingForm.get('date')?.touched) || meetingForm.errors?.['invalidDate'] ? 'dateError' : null"
                             [min]="getMinDate()"
                             [max]="getMaxDate()" />
                      <label for="meetingDate">{{ translationService.translate('profile.meetingDate') || 'تاريخ الاجتماع' }}</label>
                      <div *ngIf="meetingForm.get('date')?.invalid && meetingForm.get('date')?.touched"
                           id="dateError"
                           class="invalid-feedback">
                        <span *ngIf="meetingForm.get('date')?.errors?.['required']">
                          {{ translationService.translate('profile.validation.date.required') || 'التاريخ مطلوب' }}
                        </span>
                      </div>
                      <div *ngIf="meetingForm.errors?.['invalidDate']" id="dateError" class="invalid-feedback">
                        {{ translationService.translate('profile.validation.date.invalid') || 'التاريخ غير صالح' }}
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 col-sm-12 mb-2">
                    <div class="form-floating">
                      <input id="meetingStartTime"
                             formControlName="startTime"
                             type="time"
                             class="form-control"
                             [class.is-invalid]="(meetingForm.get('startTime')?.invalid && meetingForm.get('startTime')?.touched) || meetingForm.errors?.['invalidTimeOrder']"
                             [attr.aria-label]="translationService.translate('profile.meetingStartTime') || 'وقت بدء الاجتماع'"
                             [attr.aria-describedby]="(meetingForm.get('startTime')?.invalid && meetingForm.get('startTime')?.touched) || meetingForm.errors?.['invalidTimeOrder'] ? 'startTimeError' : null" />
                      <label for="meetingStartTime">{{ translationService.translate('profile.meetingStartTime') || 'وقت بدء الاجتماع' }}</label>
                      <div *ngIf="meetingForm.get('startTime')?.invalid && meetingForm.get('startTime')?.touched"
                           id="startTimeError"
                           class="invalid-feedback">
                        <span *ngIf="meetingForm.get('startTime')?.errors?.['required']">
                          {{ translationService.translate('profile.validation.startTime.required') || 'وقت البدء مطلوب' }}
                        </span>
                        <span *ngIf="meetingForm.get('startTime')?.errors?.['pattern']">
                          {{ translationService.translate('profile.validation.time.format') || 'تنسيق الوقت غير صالح' }}
                        </span>
                      </div>
                      <div *ngIf="meetingForm.errors?.['invalidTimeOrder']" id="startTimeError" class="invalid-feedback">
                        {{ translationService.translate('profile.validation.time.order') || 'وقت البدء يجب أن يكون قبل وقت الانتهاء' }}
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 col-sm-12 mb-2">
                    <div class="form-floating">
                      <input id="meetingEndTime"
                             formControlName="endTime"
                             type="time"
                             class="form-control"
                             [class.is-invalid]="(meetingForm.get('endTime')?.invalid && meetingForm.get('endTime')?.touched) || meetingForm.errors?.['invalidTimeOrder']"
                             [attr.aria-label]="translationService.translate('profile.meetingEndTime') || 'وقت انتهاء الاجتماع'"
                             [attr.aria-describedby]="(meetingForm.get('endTime')?.invalid && meetingForm.get('endTime')?.touched) || meetingForm.errors?.['invalidTimeOrder'] ? 'endTimeError' : null" />
                      <label for="meetingEndTime">{{ translationService.translate('profile.meetingEndTime') || 'وقت انتهاء الاجتماع' }}</label>
                      <div *ngIf="meetingForm.get('endTime')?.invalid && meetingForm.get('endTime')?.touched"
                           id="endTimeError"
                           class="invalid-feedback">
                        <span *ngIf="meetingForm.get('endTime')?.errors?.['required']">
                          {{ translationService.translate('profile.validation.endTime.required') || 'وقت الانتهاء مطلوب' }}
                        </span>
                        <span *ngIf="meetingForm.get('endTime')?.errors?.['pattern']">
                          {{ translationService.translate('profile.validation.time.format') || 'تنسيق الوقت غير صالح' }}
                        </span>
                      </div>
                      <div *ngIf="meetingForm.errors?.['invalidTimeOrder']" id="endTimeError" class="invalid-feedback">
                        {{ translationService.translate('profile.validation.time.order') || 'وقت الانتهاء يجب أن يكون بعد وقت البدء' }}
                      </div>
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" (click)="closeMeetingModal()"
                        [disabled]="isAddingMeeting"
                        [attr.aria-label]="translationService.translate('common.cancel') || 'إلغاء'">
                  {{ translationService.translate('common.cancel') || 'إلغاء' }}
                </button>
                <button type="button" class="btn btn-primary btn-sm" (click)="addMeeting()"
                        [disabled]="isAddingMeeting || meetingForm.invalid"
                        [attr.aria-label]="translationService.translate('profile.saveMeeting') || 'حفظ الاجتماع'">
                  <span *ngIf="isAddingMeeting" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  {{ isAddingMeeting ? (translationService.translate('profile.saving') || 'جارٍ الحفظ') : (translationService.translate('profile.saveMeeting') || 'حفظ الاجتماع') }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</body>
</html>
